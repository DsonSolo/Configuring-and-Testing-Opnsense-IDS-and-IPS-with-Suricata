# Configuring and Testing Opnsense IDS and IPS with Suricata
 **Configuring and Testing OPNsense IDS/IPS with Suricata**

In this project, I successfully implemented the installation,
configuration, and testing of Opnsense IDS/IPS with Suricata. The
endeavor encompassed creating a multi-LAN virtual environment,
configuring the Opnsense Firewall with 2 LAN interfaces, and
incorporating Kali Linux and Metasploitable 2.0 Linux virtual machines.

**Requirements:**

- Multi LAN Virtual environment from lab 3.0

- Opnsense Firewall configured with 2 LAN interfaces (Completed Lab 4.0)

- Kali Linux Virtual Machine

- Metasploitable Virtual Machine (Extract both downloads into the
  Virtual Machines folder and import into Virtual BOX by scanning for
  new machines)

**Steps:**

1.  Setting up Network:

- Configured Kali Linux on the guest network.

- Placed Metasploitable on the LAN network.

2.  Package Check:

- Checked for the Suricata package.

3.  IDS Configuration:

- Configured IDS on Opnsense.

4.  IDS Testing:

- Tested IDS functionality.

5.  Analyzing Alerts Logs:

- Analyzed logs generated by IDS alerts.

6.  IPS Configuration:

- Configured IPS on Opnsense.

7.  IPS Testing:

- Conducted testing to verify IPS effectiveness.

8.  Analyzing Alert Logs:

- Analyzed logs generated by IPS alerts.

**Note Before Starting Lab:**

In preparation for the lab, I ensured the shutdown of Guest PC2 and the
ClamAV daemon service to optimize resources. System requirements for
Kali Linux OS included a CPU Core of 2 Cores and 2 GB of RAM. The lab
indicated 192.168.2.163 as the target IP, with the actual IP varying
based on individual machines.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image1.png)

I ensured the successful connection to the network by executing ifconfig
on my Kali Linux machine.

**Note**: For users with the latest Kali Linux version, the command
might result in "**command not found**" due to the recent modification
of the default login to non-root access.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image2.png)

To overcome this, I utilized the **sudo su** command to switch users.
Entering the default password 'kali' granted access to the root user.

**Note**: While it's a best practice to change credentials, for the sake
of demonstration, I retained the default settings.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image3.png)

Upon successful login as root, I executed the **ifconfig** command. The
output confirmed that I was connected to the guest network, evidenced by
the assigned IP address 192.168.3.11.

This configuration replicates a scenario where an attacker has breached
the guest network, endeavoring to pivot and escalate the attack.

**Step 2: Setting Up Metasploitable on the LAN Network**

Now, I proceeded with similar steps on the Metasploitable machine.

Firstly, I removed the second Network Adapter and configured the
remaining one to the Internal Network (LAN). This change optimizes
resource usage, allowing us to focus on setting up Suricata.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image4.png)

Note: Suricata should already be preinstalled on Opnsense; let's verify.

**Step 2 (Continued): Verifying Suricata Package**

Navigating to System \> Firmware \> Packages, I confirmed the presence
of Suricata. This is also the space to reinstall Suricata if needed.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image5.png)

**Step 2 (Continued): Configuring IDS**

Firstly, let's experiment with the Intrusion Detection System (IDS)
only. Heading to Services \> Intrusion Detection \> Administration:

1.  Turned on the IDS.

2.  Enabled Promiscuous mode.

3.  Activated syslog alerts.

4.  Changed the pattern matcher to Hyperscan.

5.  Aligned the interface to Guestnetwork and LAN.

6.  Applied the changes and proceeded to download and install Suricata
    packages.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image6.png)

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image7.png)

Next, I visited the Rules tab to manage and enable specific rules.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image8.png)

**Note**: Running a reconnaissance attack from Kali is part of our test.

The results showed alerts picking up a potential Kali Linux presence on
the network, demonstrating the IDS's capability.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image9.png)

**Step 2 (Continued): Transitioning to IPS**

To simulate more realistic scenarios, I turned on the IPS. After
powering on the Metasploitable machine, we initiated an aggressive scan
from Kali, showcasing the IPS's ability to block intrusive activities.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image10.png)

This deliberate aggressiveness in the scan revealed the IDS's robust
capability to detect and respond to potentially malicious activities.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image11.png)

**Blocking the aggressive scan:**

To actively respond to the identified threat, I took several steps
within Services \> Intrusion Detection \> Administration:

1.  Enabled IPS mode to empower the Intrusion Prevention System.

2.  Applied the changes.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image12.png)

3.  In the download tab, enabled (drop filter) and downloaded & updated
    rules.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image13.png)

Further customization involved adjusting rules in Policy and Rule
adjustments, focusing on the 'NMAP'.

I specifically edited rule \#2024364 (ET SCAN Possible Nmap User-Agent
Observed), changing its Action to 'Drop,' indicating a proactive
response to potential threats.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image14.png)

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image15.png)

After implementing the changes, I retested the aggressive scan from Kali
('nmap -A 192.168.2.11'). This step was crucial in evaluating the
effectiveness of the configured IPS.

Post-retest, the IDS alerts confirmed the successful blocking of the
aggressive scan, validating the capabilities of the Intrusion Prevention
System.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image16.png)

**Demonstrating IPS capabilities with Metasploitable:**

Transitioning to showcasing Intrusion Prevention System (IPS)
capabilities, I began by turning off IPS in Services \> Administration
\> Settings. This allowed for a controlled demonstration of potential
exploits when only the IDS is active.

Subsequently, I powered on the Metasploitable machine, obtained my IP
address (192.168.2.1), and initiated the exploration of potential
vulnerabilities.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image17.png)

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image18.png)

To simulate an attack, I ran 'nmap -F,' scanning open ports on
Metasploitable.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image19.png)

This was followed by launching Metasploit and searching for the 'vsftpd'
exploit. On Linux machines, vsftpd is the ftp server used and ironically
stands for very secure FTP daemon.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image20.png)

The successful exploitation of 'vsftpd' resulted in gaining root access
to the Metasploitable machine, effectively illustrating the potential
risks.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image21.png)

Post-exploitation, Opnsense generated alerts, indicating potential
security breaches. Despite the successful attack, these alerts played a
crucial role in detecting and documenting the security incident.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image22.png)

To enhance security measures, I re-enabled IPS in Services \>
Administration \> Settings. This was accompanied by a restart of the
Metasploitable machine.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image23.png)

A subsequent attempt to exploit the same vulnerability from Kali Linux
revealed the successful blocking of the attack by the configured IPS.

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image24.png)

![Screenshot](https://github.com/DsonSolo/Configuring-and-Testing-Opnsense-IDS-and-IPS-with-Suricata/blob/main/image25.png)

**Conclusion of the Lab:**

The comprehensive lab, encompassing both IDS and IPS configurations,
successfully demonstrated the robust security measures in place. The
effective detection and prevention of potential threats showcased the
importance of a well-configured and actively monitored network security
system.

